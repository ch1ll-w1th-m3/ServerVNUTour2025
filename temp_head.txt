"""
Slash commands for the bot
"""
import discord
from discord import app_commands
from discord.ext import commands
from ..music.player import get_player, ensure_voice, after_play_callback, force_cleanup_ffmpeg_source
from ..music.ytdlp_handler import ytdlp_extract, build_ffmpeg_options
import asyncio
import threading


class VolumeControlledAudioSource(discord.FFmpegPCMAudio):
    """Custom audio source with volume control"""
    
    def __init__(self, source, volume=1.0, **kwargs):
        super().__init__(source, **kwargs)
        self._volume = volume
    
    @property
    def volume(self):
        return self._volume
    
    @volume.setter
    def volume(self, value):
        self._volume = max(0.0, min(2.0, value))
    
    def read(self):
        """Read audio data with volume applied"""
        data = super().read()
        if data and self._volume != 1.0:
            # Apply volume by scaling the audio data
            import array
            audio_array = array.array('h', data)
            for i in range(len(audio_array)):
                audio_array[i] = int(audio_array[i] * self._volume)
            data = audio_array.tobytes()
        return data


def setup_slash_commands(bot):
    """Setup all slash commands"""
    
    # Music Commands Group
    @bot.tree.command(name="play", description="PhÃ¡t nháº¡c tá»« YouTube")
    @app_commands.describe(query="TÃªn bÃ i hÃ¡t hoáº·c URL YouTube")
    async def play_slash(interaction: discord.Interaction, query: str):
        """PhÃ¡t nháº¡c tá»« YouTube"""
        try:
            # Defer the response since this might take a while
            await interaction.response.defer()
            
            # Create a mock context for compatibility with existing functions
            class MockContext:
                def __init__(self, interaction):
                    self.guild = interaction.guild
                    self.channel = interaction.channel
                    self.author = interaction.user
                    self.message = interaction
                    
                async def send(self, content=None, embed=None):
                    if interaction.response.is_done():
                        return await interaction.followup.send(content=content, embed=embed)
                    else:
                        return await interaction.response.send_message(content=content, embed=embed)
            
            ctx = MockContext(interaction)
            
            # Ensure bot is in voice channel
            vc = await ensure_voice(ctx.message)
            
            # Get or create player
            player = get_player(ctx.guild.id)
            player.text_channel_id = ctx.channel.id
            
            # Show searching message
            await interaction.followup.send(f"ğŸ” **Äang tÃ¬m kiáº¿m:** {query}")
            
            try:
                # Extract track info
                track = await ytdlp_extract(query, ctx.author.id)
                
                # Add to queue
                player.add_track(track)
                
                # Update message
                await interaction.followup.send(f"âœ… **ÄÃ£ thÃªm vÃ o queue:** {track.title}")
                
                # Start playing if not already playing
                if not vc.is_playing():
                    asyncio.create_task(play_next(ctx.guild, vc, player))
                    
            except Exception as e:
                await interaction.followup.send(f"âŒ **Lá»—i:** {str(e)}")
                
        except Exception as e:
            if not interaction.response.is_done():
                await interaction.response.send_message(f"âŒ **Lá»—i:** {str(e)}")
            else:
                await interaction.followup.send(f"âŒ **Lá»—i:** {str(e)}")
    
    @bot.tree.command(name="skip", description="Bá» qua bÃ i hÃ¡t hiá»‡n táº¡i")
    async def skip_slash(interaction: discord.Interaction):
        """Bá» qua bÃ i hÃ¡t hiá»‡n táº¡i"""
        try:
            vc = interaction.guild.voice_client
            if not vc or not vc.is_connected():
                await interaction.response.send_message("âŒ Bot khÃ´ng á»Ÿ trong voice channel")
                return
            
            if vc.is_playing():
                # Stop current track and trigger next
                vc.stop()
                await interaction.response.send_message("â­ï¸ **ÄÃ£ bá» qua bÃ i hÃ¡t hiá»‡n táº¡i**")
                
                # Get player and play next track
                player = get_player(interaction.guild.id)
                if player.queue:
                    await interaction.followup.send("ğŸ”„ **Äang chuyá»ƒn sang bÃ i tiáº¿p theo...**")
                    asyncio.create_task(play_next(interaction.guild, vc, player))
                else:
                    await interaction.followup.send("ğŸ“­ **Queue Ä‘Ã£ háº¿t, khÃ´ng cÃ²n bÃ i nÃ o Ä‘á»ƒ phÃ¡t**")
            else:
                await interaction.response.send_message("âŒ KhÃ´ng cÃ³ gÃ¬ Ä‘ang phÃ¡t")
                
        except Exception as e:
            await interaction.response.send_message(f"âŒ **Lá»—i:** {str(e)}")
    
    @bot.tree.command(name="queue", description="Hiá»ƒn thá»‹ queue nháº¡c")
    async def queue_slash(interaction: discord.Interaction):
        """Hiá»ƒn thá»‹ queue nháº¡c"""
        try:
            player = get_player(interaction.guild.id)
            queue_info = player.get_queue_info()
            
            if player.now_playing:
                now_playing = f"ğŸµ **Äang phÃ¡t:** {player.now_playing.title}\n\n"
            else:
                now_playing = ""
            
            await interaction.response.send_message(f"{now_playing}{queue_info}")
            
        except Exception as e:
            await interaction.response.send_message(f"âŒ **Lá»—i:** {str(e)}")
    
    @bot.tree.command(name="stop", description="Dá»«ng phÃ¡t nháº¡c vÃ  rá»i voice channel")
    async def stop_slash(interaction: discord.Interaction):
        """Dá»«ng phÃ¡t nháº¡c vÃ  rá»i voice channel"""
        try:
            vc = interaction.guild.voice_client
            if not vc or not vc.is_connected():
                await interaction.response.send_message("âŒ Bot khÃ´ng á»Ÿ trong voice channel")
                return
            
            # Clear queue and stop
            player = get_player(interaction.guild.id)
            player.clear_queue()
            player.skip_current()
            
            # Disconnect
            await vc.disconnect()
            await interaction.response.send_message("â¹ï¸ **ÄÃ£ dá»«ng phÃ¡t nháº¡c vÃ  rá»i voice channel**")
            
        except Exception as e:
            await interaction.response.send_message(f"âŒ **Lá»—i:** {str(e)}")
    
    @bot.tree.command(name="volume", description="Äiá»u chá»‰nh Ã¢m lÆ°á»£ng (0-200%)")
    @app_commands.describe(level="Má»©c Ã¢m lÆ°á»£ng tá»« 0 Ä‘áº¿n 200 (%)")
    async def volume_slash(interaction: discord.Interaction, level: int):
        """Äiá»u chá»‰nh Ã¢m lÆ°á»£ng (0-200%)"""
        try:
            if not 0 <= level <= 200:
                await interaction.response.send_message("âŒ Ã‚m lÆ°á»£ng pháº£i tá»« 0% Ä‘áº¿n 200%")
                return
            
            player = get_player(interaction.guild.id)
            # Convert percentage to decimal (0-2.0)
            volume_decimal = level / 100.0
            player.set_volume(volume_decimal)
            
            # Apply volume to currently playing audio if any
            vc = interaction.guild.voice_client
            if vc and vc.is_playing() and player.now_playing:
                # Use our custom volume control
                if hasattr(vc.source, 'volume'):
                    vc.source.volume = volume_decimal
                    await interaction.response.send_message(f"ğŸ”Š **Ã‚m lÆ°á»£ng Ä‘Ã£ Ä‘Æ°á»£c Ä‘áº·t thÃ nh:** {level}% (Ã¡p dá»¥ng ngay láº­p tá»©c)")
                else:
                    # Fallback to FFmpeg method if source doesn't support volume
                    await apply_volume_from_current_position(vc, player, volume_decimal)
                    await interaction.response.send_message(f"ğŸ”Š **Ã‚m lÆ°á»£ng Ä‘Ã£ Ä‘Æ°á»£c Ä‘áº·t thÃ nh:** {level}% (Ä‘ang Ã¡p dá»¥ng...)")
            else:
                await interaction.response.send_message(f"ğŸ”Š **Ã‚m lÆ°á»£ng Ä‘Ã£ Ä‘Æ°á»£c Ä‘áº·t thÃ nh:** {level}%")
            
        except Exception as e:
            await interaction.response.send_message(f"âŒ **Lá»—i:** {str(e)}")
    
    # Admin Commands
    @bot.tree.command(name="ping", description="Kiá»ƒm tra Ä‘á»™ trá»… cá»§a bot")
    async def ping_slash(interaction: discord.Interaction):
        """Kiá»ƒm tra Ä‘á»™ trá»… cá»§a bot"""
        latency = round(bot.latency * 1000)
        await interaction.response.send_message(f"ğŸ“ **Pong!** Äá»™ trá»…: {latency}ms")
    
    @bot.tree.command(name="info", description="ThÃ´ng tin vá» bot")
    async def info_slash(interaction: discord.Interaction):
        """ThÃ´ng tin vá» bot"""
        embed = discord.Embed(
            title="ğŸ¤– **VnuTourBot**",
            description="Bot quáº£n lÃ½ tour VNU vá»›i chá»©c nÄƒng Ã¢m nháº¡c",
            color=0x00ff00
        )
        
        embed.add_field(
            name="ğŸ“Š **Thá»‘ng kÃª**",
            value=f"Servers: {len(bot.guilds)}\nUsers: {len(bot.users)}",
            inline=True
        )
        
        embed.add_field(
            name="ğŸ“ **Äá»™ trá»…**",
            value=f"{round(bot.latency * 1000)}ms",
            inline=True
        )
        
        embed.add_field(
            name="ğŸ **PhiÃªn báº£n**",
            value=f"discord.py {discord.__version__}",
            inline=True
        )
        
        embed.set_footer(text="VnuTourBot v1.0")
        await interaction.response.send_message(embed=embed)
    
    @bot.tree.command(name="clear", description="XÃ³a tin nháº¯n (chá»‰ admin)")
    @app_commands.describe(amount="Sá»‘ lÆ°á»£ng tin nháº¯n cáº§n xÃ³a")
    @app_commands.default_permissions(manage_messages=True)
    async def clear_slash(interaction: discord.Interaction, amount: int):
        """XÃ³a tin nháº¯n (chá»‰ admin)"""
        try:
            if amount < 1 or amount > 100:
                await interaction.response.send_message("âŒ Sá»‘ lÆ°á»£ng tin nháº¯n pháº£i tá»« 1 Ä‘áº¿n 100")
                return
            
            # Defer response since this might take a while
            await interaction.response.defer(ephemeral=True)
            
            deleted = await interaction.channel.purge(limit=amount)
            await interaction.followup.send(f"ğŸ—‘ï¸ **ÄÃ£ xÃ³a {len(deleted)} tin nháº¯n**", ephemeral=True)
            
